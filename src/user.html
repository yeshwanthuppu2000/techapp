<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Enterprise AI Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse {
            0% { box-shadow: 0 0 20px rgba(0, 255, 255, 0.5); }
            50% { box-shadow: 0 0 30px rgba(0, 255, 255, 0.8); }
            100% { box-shadow: 0 0 20px rgba(0, 255, 255, 0.5); }
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #0f172a; color: #e2e8f0; }
        #bg-animation { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .navbar-custom { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0, 255, 255, 0.2); }
        .navbar-custom .nav-link, .navbar-custom .navbar-brand { color: #e2e8f0; }
        .navbar-custom .nav-link:hover, .navbar-custom .nav-link.active { color: #00ffff; text-shadow: 0 0 5px rgba(0, 255, 255, 0.5); }
        .content-container { padding-top: 80px; animation: fadeIn 1s ease-out; }
        .dashboard-card { background: rgba(15, 23, 42, 0.7); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 15px; padding: 2rem; margin-bottom: 2rem; backdrop-filter: blur(5px); box-shadow: 0 0 15px rgba(0, 255, 255, 0.1); }
        .card-header-icon { font-size: 1.5rem; color: #00ffff; margin-right: 1rem; text-shadow: 0 0 10px rgba(0, 255, 255, 0.5); }
        .btn-outline-cyan { color: #00ffff; border-color: #00ffff; transition: background-color 0.3s, color 0.3s; }
        .btn-outline-cyan:hover { background-color: #00ffff; color: #0f172a; box-shadow: 0 0 15px rgba(0, 255, 255, 0.5); }
        .profile-dropdown .dropdown-menu { background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(0, 255, 255, 0.2); }
        .profile-dropdown .dropdown-item, .profile-dropdown .dropdown-item-text { color: #e2e8f0; }
        .profile-dropdown .dropdown-item:hover { background-color: rgba(0, 255, 255, 0.1); }

        /* Chatbot styles */
        .chatbot-fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background-color: #00ffff; color: #0f172a; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; animation: pulse 2s infinite; z-index: 1050; }
        .chatbot-popup { display: none; position: fixed; bottom: 100px; right: 30px; width: 350px; height: 500px; background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 15px; flex-direction: column; overflow: hidden; z-index: 1049; box-shadow: 0 0 30px rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); }
        .chatbot-header { padding: 1rem; border-bottom: 1px solid rgba(0, 255, 255, 0.2); }
        .chatbot-messages { flex-grow: 1; padding: 1rem; overflow-y: auto; }
        .chatbot-input { padding: 1rem; border-top: 1px solid rgba(0, 255, 255, 0.2); display: flex; }
        .recording-indicator { display: none; align-items: center; padding: 0.5rem; background-color: rgba(255, 0, 0, 0.2); }
        .message { margin-bottom: 1rem; }
        .message p { margin-bottom: 0.25rem; }
        .message audio { width: 100%; margin-top: 0.5rem; }
    </style>
</head>
<body>
    <canvas id="bg-animation"></canvas>
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="fas fa-brain me-2"></i>Enterprise AI Portal</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link active" href="/user">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="/profile_page">My Profile</a></li>
                </ul>
                <div class="nav-item dropdown profile-dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-user-circle me-1"></i> <span id="profile-username"></span></a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                        <li><div class="dropdown-item-text">Username: <span id="profile-username-val"></span></div></li>
                        <li><div class="dropdown-item-text">Role: <span id="profile-role-val"></span></div></li>
                        <li><div class="dropdown-item-text">Email: <span id="profile-email-val"></span></div></li>
                        <li><hr class="dropdown-divider" style="border-color: rgba(0, 255, 255, 0.2);"></li>
                        <li><a class="dropdown-item" href="/logout">Sign Out</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container content-container">
        <h1 class="text-white mb-4">User Dashboard</h1>
        <div class="row">
            <div class="col-lg-6">
                <div class="dashboard-card">
                    <h5 class="d-flex align-items-center text-white"><i class="fas fa-robot card-header-icon"></i>AI Tools</h5>
                    <p class="text-white-50">Access your assigned AI-powered tools and features.</p>
                    <button class="btn btn-outline-cyan">Launch Tools</button>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="dashboard-card">
                    <h5 class="d-flex align-items-center text-white"><i class="fas fa-tasks card-header-icon"></i>My Projects</h5>
                    <p class="text-white-50">View and manage your ongoing projects.</p>
                     <button class="btn btn-outline-cyan">View Projects</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chatbot FAB -->
    <div class="chatbot-fab" id="chatbot-fab"><i class="fas fa-robot"></i></div>

    <!-- Chatbot Popup -->
    <div class="chatbot-popup" id="chatbot-popup">
        <div class="chatbot-header"><h5 class="mb-0">AiTeach Assistant</h5></div>
        <div class="chatbot-messages" id="chatbot-messages"></div>
        <div class="recording-indicator" id="recording-indicator">
            <span>Recording...</span>
            <button class="btn btn-danger btn-sm ms-auto" id="stop-record-btn"><i class="fas fa-stop"></i></button>
        </div>
        <div class="chatbot-input">
            <input type="text" class="form-control bg-dark text-white" placeholder="Ask me anything...">
            <button class="btn btn-outline-light ms-2" id="file-input-btn"><i class="fas fa-paperclip"></i></button>
            <input type="file" id="file-input" style="display: none;">
            <button class="btn btn-outline-light ms-2" id="record-audio-btn"><i class="fas fa-microphone"></i></button>
            <button class="btn btn-primary ms-2"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let username = '';
            fetch('/profile').then(res => res.json()).then(data => {
                username = data.username;
                document.getElementById('profile-username').textContent = data.username;
                document.getElementById('profile-username-val').textContent = data.username;
                document.getElementById('profile-role-val').textContent = data.role;
                document.getElementById('profile-email-val').textContent = data.email;
            });

            const chatbotFab = document.getElementById('chatbot-fab');
            const chatbotPopup = document.getElementById('chatbot-popup');
            const chatbotMessages = document.getElementById('chatbot-messages');
            const recordAudioBtn = document.getElementById('record-audio-btn');
            const stopRecordBtn = document.getElementById('stop-record-btn');
            const recordingIndicator = document.getElementById('recording-indicator');
            const fileInputBtn = document.getElementById('file-input-btn');
            const fileInput = document.getElementById('file-input');
            let mediaRecorder;
            let audioChunks = [];

            function addMessage(content, isUser = false) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message');
                if (isUser) { messageElement.classList.add('user-message'); }
                messageElement.innerHTML = content;
                chatbotMessages.appendChild(messageElement);
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            }

            chatbotFab.addEventListener('click', () => {
                const isHidden = chatbotPopup.style.display === 'none' || chatbotPopup.style.display === '';
                chatbotPopup.style.display = isHidden ? 'flex' : 'none';
                if (isHidden && chatbotMessages.children.length === 0) {
                   addMessage(`<p>Welcome ${username}! I am AiTeach your chat assistant. Please feel free to ask anything.</p>`);
                }
            });
            
            fileInputBtn.addEventListener('click', () => fileInput.click());

            recordAudioBtn.addEventListener('click', async () => {
                if (!mediaRecorder || mediaRecorder.state === "inactive") {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        mediaRecorder.ondataavailable = event => { audioChunks.push(event.data); };
                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                            const audioUrl = URL.createObjectURL(audioBlob);
                            const audioPlayer = `<audio controls src="${audioUrl}"></audio>`;
                            addMessage(audioPlayer, true);
                            audioChunks = [];
                            recordingIndicator.style.display = 'none';
                            recordAudioBtn.disabled = false;
                        };
                        mediaRecorder.start();
                        recordingIndicator.style.display = 'flex';
                        recordAudioBtn.disabled = true;
                    } catch (err) {
                        console.error("Error accessing microphone:", err);
                        alert("Could not access microphone. Please ensure you have given permission.");
                    }
                }
            });

            stopRecordBtn.addEventListener('click', () => {
                if (mediaRecorder && mediaRecorder.state === "recording") { mediaRecorder.stop(); }
            });

            const canvas = document.getElementById('bg-animation');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            let particlesArray;

            class Particle { constructor() { this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height; this.size = Math.random() * 2 + 1; this.speedX = Math.random() * 0.5 - 0.25; this.speedY = Math.random() * 0.5 - 0.25; this.color = 'rgba(0, 255, 255, 0.5)'; } update() { if (this.x > canvas.width || this.x < 0) this.speedX *= -1; if (this.y > canvas.height || this.y < 0) this.speedY *= -1; this.x += this.speedX; this.y += this.speedY; } draw() { ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); } }
            function init() { particlesArray = []; let numberOfParticles = (canvas.height * canvas.width) / 9000; for (let i = 0; i < numberOfParticles; i++) { particlesArray.push(new Particle()); } }
            function animate() { ctx.clearRect(0, 0, canvas.width, canvas.height); for (let i = 0; i < particlesArray.length; i++) { particlesArray[i].update(); particlesArray[i].draw(); } connect(); requestAnimationFrame(animate); }
            function connect() { let opacityValue = 1; for (let a = 0; a < particlesArray.length; a++) { for (let b = a; b < particlesArray.length; b++) { let distance = ((particlesArray[a].x - particlesArray[b].x) * (particlesArray[a].x - particlesArray[b].x)) + ((particlesArray[a].y - particlesArray[b].y) * (particlesArray[a].y - particlesArray[b].y)); if (distance < (canvas.width / 7) * (canvas.height / 7)) { opacityValue = 1 - (distance / 20000); ctx.strokeStyle = `rgba(0, 255, 255, ${opacityValue})`; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(particlesArray[a].x, particlesArray[a].y); ctx.lineTo(particlesArray[b].x, particlesArray[b].y); ctx.stroke(); } } } }
            window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; init(); });
            init();
            animate();
        });
    </script>
</body>
</html>
